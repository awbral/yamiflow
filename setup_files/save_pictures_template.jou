(define case-name "|CASE|")
(define yarn-radius |YARN_RADIUS|)
(define yarn-length |YARN_LENGTH|)
(define rotation-angle -|ROT_ANGLE|)
(define rotation-axis "|ROT_AXIS|")
(define v_array (list|V_LIST|))

(define surface-start (/ yarn-length -2))
(define case-name-update case-name)

/file/set-batch-options n n n
/file/async-optimize? yes
/file/cffio-options/io-mode 4
/display/set/windows/logo? no
/display/views/camera/projection orthographic
/display/views/camera/target 0 0 0
/display/views/camera/position 0 0 1
/display/views/camera/up-vector 0 1 0
/display/views/camera/field (* yarn-radius 10) (* yarn-radius 10)

/display/set/picture/driver png
/display/set/picture/use-window-resolution? no
/display/set/picture/set-standard-resolution "2K QHD (2560x1440)"
!mkdir snapshots

; start velocity sweep loop
(do ((k 0 (+ k 1 ))) ((>= k (length v_array)))
	(set! case-name-update (string-append case-name (format  #f "_v~a" (list-ref v_array k))))
	(ti-menu-load-string (format #f "/file/read-case-data ~a\n" case-name-update))
	(system (format #f "mkdir snapshots/v~a \n" (list-ref v_array k)))

	; rotate zones: pictures in yarn reference frame
	(if (not (= rotation-angle 0))
    		(ti-menu-load-string (format #f "/mesh/rotate ~a 0 0 0 ~a\n" rotation-angle rotation-axis))
	)

	(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
	(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
	(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
    	(ti-menu-load-string (format #f "/plot/residuals yes yes yes yes yes yes yes \n"))
   	(ti-menu-load-string (format #f "/display/save-picture residuals \n"))
    	(ti-menu-load-string (format #f "/display/save-picture snapshots/residuals \n"))
	(ti-menu-load-string (format #f "/display/save-picture snapshots/v~a/residuals \n" (list-ref v_array k)))

	(ti-menu-load-string (format #f "/define/custom-field-functions/define \"vel-mag-xy-rel\" (sqrt((x_velocity^2+y_velocity^2)))/~a \n" (list-ref v_array k)))
	(do ((j 0 (+ j 1))) ((> j 25))
		(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 0 0 0 \n"))
		(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
		(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
		(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Left\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 1 \n"))
		(ti-menu-load-string (format #f "/surface/plane-surface xy-~a xy-plane (- ~a (* ~a (/ ~a 25))) \n" j surface-start j surface-start))
		(ti-menu-load-string (format #f "/display/objects/create contour velocity_xy-~a field velocity-magnitude range-option auto-range-on global-range? yes q surfaces-list xy-~a () q \n" j j))
		(ti-menu-load-string (format #f "/display/objects/display velocity_xy-~a \n" j))
		(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/position 0 0 1 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/up-vector 0 1 0 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/field (* 177.31e-6 10) (* 177.31e-6 10) \n"))
		(if (< j 10)
			(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/velocity_xy-0~a \n" (list-ref v_array k) j))
			(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/velocity_xy-~a \n" (list-ref v_array k) j))
		)
		(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 255 255 255 \n"))
		(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
		(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
		(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Left\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
		(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 3 \n"))
		(ti-menu-load-string (format #f "/display/objects/create contour vel_xy_in_plane-~a field vel-mag-xy-rel range-option auto-range-on global-range? yes q surfaces-list xy-~a () q \n" j j))
		(ti-menu-load-string (format #f "/display/objects/create vector vector_xy_in_plane-~a color-map visible? no q field vel-mag-xy-rel scale scale-f 1.5 q skip 50 style \"arrow\" surfaces-list xy-~a () vector-field velocity vector-opt color \"black\" in-plane? yes q q \n" j j))
		(ti-menu-load-string (format #f "/display/objects/display vel_xy_in_plane-~a \n" j))
		(ti-menu-load-string (format #f "/display/objects/add-to-graphics vector_xy_in_plane-~a \n" j))
		(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/position 0 0 1 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/up-vector 0 1 0 \n"))
		(ti-menu-load-string (format #f "/display/views/camera/field (* 177.31e-6 10) (* 177.31e-6 10) \n"))
		(if (< j 10)
			(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/vel-mag-xy-rel-0~a \n" (list-ref v_array k) j))
			(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/vel-mag-xy-rel-~a \n" (list-ref v_array k) j))
		)
	)

	(ti-menu-load-string (format #f "/surface/plane-surface yz point-and-normal 0 0 0 normal 1 0 0 \n"))
	(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
	(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
	(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Top\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 1 \n"))
	(ti-menu-load-string (format #f "/display/objects/create contour velocity_yz field velocity-magnitude range-option auto-range-on global-range? yes q surfaces-list yz () q \n"))
	(ti-menu-load-string (format #f "/display/objects/display velocity_yz \n"))
	(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/position 1 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/up-vector 0 -1 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/field (* yarn-length 1.78) (* yarn-length 1) \n"))
	(ti-menu-load-string (format #f "/display/save-picture snapshots/v~a/velocity_yz \n" (list-ref v_array k)))
	(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 255 255 255 \n"))
	(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
	(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
	(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Top\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 3 \n"))
	(ti-menu-load-string (format #f "/display/objects/create contour vel-mag-xy-rel-yz-plane field vel-mag-xy-rel range-option auto-range-on global-range? yes q surfaces-list yz () q \n"))
	(ti-menu-load-string (format #f "/display/objects/display vel-mag-xy-rel-yz-plane \n"))
	(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/position 1 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/up-vector 0 -1 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/field (* yarn-length 1.78) (* yarn-length 1) \n"))
	(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/vel-mag-xy-rel-yz-plane \n" (list-ref v_array k)))

	(ti-menu-load-string (format #f "/surface/plane-surface xz point-and-normal 0 0 0 normal 0 1 0 \n"))
	(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
	(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
	(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Top\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 1 \n"))
	(ti-menu-load-string (format #f "/display/objects/create contour velocity_xz field velocity-magnitude range-option auto-range-on global-range? yes q surfaces-list xz () q \n"))
	(ti-menu-load-string (format #f "/display/objects/display velocity_xz \n"))
	(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/up-vector 0 0 1 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/position 0 1 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/up-vector 1 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/field (* yarn-length 1.78) (* yarn-length 1) \n"))
	(ti-menu-load-string (format #f "/display/save-picture snapshots/v~a/velocity_xz \n" (list-ref v_array k)))
	(ti-menu-load-string (format #f "/preferences/appearance/graphics-foreground-color 255 255 255 \n"))
	(ti-menu-load-string (format #f "/display/set/picture/driver png \n"))
	(ti-menu-load-string (format #f "/display/set/picture/use-window-resolution? no \n"))
	(ti-menu-load-string (format #f "/display/set/picture/set-standard-resolution \"2K QHD (2560x1440)\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/alignment \"Top\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-type \"float\" \n"))
	(ti-menu-load-string (format #f "/preferences/graphics/colormap-settings/number-format-precision 3 \n"))
	(ti-menu-load-string (format #f "/display/objects/create contour vel-mag-xy-rel-xz-plane field vel-mag-xy-rel range-option auto-range-on global-range? yes q surfaces-list xz () q \n"))
	(ti-menu-load-string (format #f "/display/objects/display vel-mag-xy-rel-xz-plane \n"))
	(ti-menu-load-string (format #f "/display/views/camera/target 0 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/position 0 1 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/up-vector 1 0 0 \n"))
	(ti-menu-load-string (format #f "/display/views/camera/field (* yarn-length 1.78) (* yarn-length 1) \n"))
	(ti-menu-load-string (format #f "/display/save-picture ./snapshots/v~a/vel-mag-xy-rel-xz-plane \n" (list-ref v_array k)))
)

/exit yes
